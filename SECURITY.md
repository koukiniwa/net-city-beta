# NET CITY β - セキュリティ設定ガイド

## 概要

このドキュメントでは、NET CITY βのFirebaseセキュリティルールの設定方法を説明します。

## セキュリティ強化内容

### 1. Firebaseセキュリティルール

`database.rules.json` ファイルに以下のセキュリティルールを設定しています：

#### ルーム情報（rooms）
- **読み取り**: 誰でも可能
- **書き込み**: 新規作成は誰でも可能、既存の更新は作成者のみ
- **バリデーション**:
  - ルーム名: 1-15文字
  - 絵文字: 必須
  - 最大人数: 0-100人
  - 説明: 最大50文字

#### ルームユーザー（roomUsers）
- **読み取り**: 誰でも可能
- **書き込み**: 自分の情報のみ
- **バリデーション**:
  - ユーザー番号: 1-999の数値

#### メッセージ（roomMessages）
- **読み取り**: 誰でも可能
- **書き込み**: 新規作成は誰でも可能、編集・削除は作成者のみ
- **バリデーション**:
  - テキスト: 1-200文字
  - ユーザー番号: 1-999の数値
  - 表示番号: "No.XXX" 形式

### 2. アプリケーション側のバリデーション

#### メッセージ送信時
- 空文字チェック
- 長さチェック（200文字以内）
- 禁止文字チェック（制御文字など）
- XSSサニタイズ

#### ルーム作成時
- ルーム名: 1-15文字
- 説明: 最大50文字
- 絵文字: 必須
- 最大人数: 10/20/30/50人のいずれか
- XSSサニタイズ

### 3. XSS対策

- すべてのユーザー入力を `sanitizeInput()` でサニタイズ
- 表示時に `escapeHtml()` でHTMLエスケープ
- URLの自動リンク化時も安全に処理

## セキュリティルールのデプロイ方法

### 前提条件

- Firebase CLIがインストールされていること
- Firebaseプロジェクトにログインしていること

### インストール

```bash
# Firebase CLIのインストール（未インストールの場合）
npm install -g firebase-tools

# Firebaseにログイン
firebase login
```

### デプロイ手順

1. **プロジェクトディレクトリに移動**

```bash
cd "new city - コピー"
```

2. **セキュリティルールをデプロイ**

```bash
firebase deploy --only database
```

3. **デプロイ確認**

Firebase Consoleで確認:
1. https://console.firebase.google.com/ にアクセス
2. プロジェクト「net-city-beta」を選択
3. 左メニューから「Realtime Database」を選択
4. 「ルール」タブをクリック
5. デプロイされたルールを確認

### セキュリティルールのテスト

Firebase Consoleの「ルール」タブで「シミュレータ」を使用してテストできます：

#### テスト例

**1. メッセージの読み取り（成功するべき）**
```
パス: /roomMessages/plaza/message123
タイプ: 読み取り
認証: なし
結果: 許可
```

**2. メッセージの書き込み（バリデーション失敗）**
```
パス: /roomMessages/plaza/message123
タイプ: 書き込み
認証: なし
データ: {"text": "あ"}  // textのみ（userIdがない）
結果: 拒否（必須フィールド不足）
```

**3. メッセージの書き込み（成功するべき）**
```
パス: /roomMessages/plaza/message123
タイプ: 書き込み
認証: なし
データ: {
  "userId": "user_123456789",
  "userNumber": 42,
  "displayNumber": "No.42",
  "text": "こんにちは",
  "timestamp": 1234567890
}
結果: 許可
```

## セキュリティ上の注意事項

### 現在の制限事項

1. **認証なし**: 現在はFirebase Authenticationを使用していません
   - ユーザーIDはローカルストレージで生成
   - 誰でもアプリを使用可能

2. **レート制限なし**: Firebase側でレート制限を設定していません
   - 大量のリクエストに対する保護がない
   - 必要に応じてFirebase App Checkの導入を検討

### 今後の改善案

1. **Firebase Authentication導入**
   - Anonymous認証を導入
   - セキュリティルールで `auth.uid` を使用

2. **Firebase App Check導入**
   - ボットや不正なクライアントからの保護
   - レート制限の実装

3. **Cloud Functions導入**
   - サーバー側でのデータバリデーション
   - 古いメッセージの自動削除
   - 不適切なコンテンツの自動検出

## トラブルシューティング

### デプロイエラー

**エラー**: `Permission denied`
```bash
# 再度ログイン
firebase login --reauth
```

**エラー**: `Project not found`
```bash
# プロジェクトを確認
firebase projects:list

# プロジェクトを切り替え
firebase use net-city-beta
```

### ルールの検証エラー

Firebaseコンソールの「ルール」タブでエラーメッセージを確認してください。

一般的なエラー:
- JSONの構文エラー
- 不正な条件式
- 存在しないフィールドへの参照

## セキュリティレポート

セキュリティ上の問題を発見した場合は、GitHubのIssuesで報告してください。

---

**最終更新**: 2025年1月
