<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ºå®šãƒ«ãƒ¼ãƒ ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2196f3;
            text-align: center;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-item {
            margin: 5px 0;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å›ºå®šãƒ«ãƒ¼ãƒ ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
        <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€NET CITY Î²ã«å›ºå®šãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
        <button id="createBtn">å›ºå®šãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹</button>
        <div id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Firebaseã®è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBv2rtsWPL8AHqnlXlRKfMkXptAvV7QBWM",
            authDomain: "net-city-beta.firebaseapp.com",
            databaseURL: "https://net-city-beta-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "net-city-beta",
            storageBucket: "net-city-beta.firebasestorage.app",
            messagingSenderId: "134573205357",
            appId: "1:134573205357:web:59080845633bf5e39b9c64"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const logDiv = document.getElementById('log');
        const createBtn = document.getElementById('createBtn');

        function addLog(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // å›ºå®šãƒ«ãƒ¼ãƒ ã®å®šç¾©
        const permanentRooms = [
            // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒª
            {
                id: 'plaza',
                name: 'åºƒå ´',
                emoji: 'ğŸ ',
                category: 'main',
                description: 'ã¿ã‚“ãªã§è‡ªç”±ã«é›‘è«‡ã—ã‚ˆã†',
                maxUsers: 50
            },
            // è¶£å‘³ã‚«ãƒ†ã‚´ãƒª
            {
                id: 'hobby_talk',
                name: 'è¶£å‘³ã‚’èªã‚ã†',
                emoji: 'ğŸ¨',
                category: 'hobby',
                description: 'è¶£å‘³ã«ã¤ã„ã¦è‡ªç”±ã«èªã‚ŠåˆãŠã†',
                maxUsers: 50
            },
            // ç›¸è«‡ã‚«ãƒ†ã‚´ãƒª
            {
                id: 'consultation_room',
                name: 'ç›¸è«‡èãã¾ã™',
                emoji: 'ğŸ¤',
                category: 'consultation',
                description: 'æ‚©ã¿ã‚„ç›¸è«‡ã€ãªã‚“ã§ã‚‚èãã¾ã™',
                maxUsers: 50
            },
            // å¤œã‚«ãƒ†ã‚´ãƒª
            {
                id: 'night_talk',
                name: 'å¤œã®ã²ã¨ã‚Šã”ã¨',
                emoji: 'ğŸŒ™',
                category: 'night',
                description: 'å¤œæ›´ã‹ã—ã•ã‚“é›†ã¾ã‚Œ',
                maxUsers: 50
            },
            // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒª
            {
                id: 'current_topics',
                name: 'ä»Šã®è©±é¡Œ',
                emoji: 'ğŸ“°',
                category: 'news',
                description: 'æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦èªã‚ã†',
                maxUsers: 50
            },
            {
                id: 'world_news',
                name: 'ä¸–ç•Œã®ãƒ‹ãƒ¥ãƒ¼ã‚¹',
                emoji: 'ğŸŒ',
                category: 'news',
                description: 'ä¸–ç•Œã®å‡ºæ¥äº‹ã‚’èªã‚ã†',
                maxUsers: 50
            }
        ];

        // å›ºå®šãƒ«ãƒ¼ãƒ ã®IDãƒªã‚¹ãƒˆ
        const permanentRoomIds = permanentRooms.map(r => r.id);

        async function createPermanentRooms() {
            createBtn.disabled = true;
            addLog('å›ºå®šãƒ«ãƒ¼ãƒ ã®ä½œæˆã‚’é–‹å§‹ã—ã¾ã™...', 'info');

            try {
                // å›ºå®šãƒ«ãƒ¼ãƒ ä»¥å¤–ã®å…¨ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤
                addLog('--- å›ºå®šãƒ«ãƒ¼ãƒ ä»¥å¤–ã‚’å‰Šé™¤ä¸­ ---', 'info');
                const allRoomsRef = ref(database, 'rooms');
                const allRoomsSnapshot = await get(allRoomsRef);

                let deletedCount = 0;
                if (allRoomsSnapshot.exists()) {
                    const allRooms = allRoomsSnapshot.val();
                    for (const roomId in allRooms) {
                        if (!permanentRoomIds.includes(roomId)) {
                            const roomRef = ref(database, `rooms/${roomId}`);
                            await set(roomRef, null);
                            addLog(`âœ“ ${roomId} (${allRooms[roomId].name || 'unknown'}) ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
                            deletedCount++;
                        }
                    }
                }
                addLog(`å‰Šé™¤å®Œäº†: ${deletedCount}ä»¶`, 'info');

                // æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
                addLog('--- å›ºå®šãƒ«ãƒ¼ãƒ ã‚’ä½œæˆä¸­ ---', 'info');
                for (const room of permanentRooms) {
                    const roomRef = ref(database, `rooms/${room.id}`);

                    // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const snapshot = await get(roomRef);

                    if (snapshot.exists()) {
                        // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ ã®ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°
                        const existingRoom = snapshot.val();
                        if (existingRoom.category !== room.category ||
                            existingRoom.name !== room.name ||
                            existingRoom.description !== room.description) {
                            addLog(`${room.name} ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ (${existingRoom.category} â†’ ${room.category})`, 'info');
                            const updatedData = {
                                ...existingRoom,
                                name: room.name,
                                emoji: room.emoji,
                                category: room.category,
                                description: room.description,
                                maxUsers: room.maxUsers,
                                isPermanent: true
                            };
                            await set(roomRef, updatedData);
                            addLog(`âœ“ ${room.name} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                        } else {
                            addLog(`${room.name} ã¯æ—¢ã«æœ€æ–°ã§ã™ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰`, 'info');
                        }
                        continue;
                    }

                    // ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                    const roomData = {
                        id: room.id,
                        name: room.name,
                        emoji: room.emoji,
                        category: room.category,
                        description: room.description,
                        maxUsers: room.maxUsers,
                        currentUsers: 0,
                        isPermanent: true,
                        createdAt: Date.now(),
                        createdBy: 'system'
                    };

                    // Firebaseã«ä¿å­˜
                    await set(roomRef, roomData);
                    addLog(`âœ“ ${room.name} ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆã‚«ãƒ†ã‚´ãƒª: ${room.category}ï¼‰`, 'success');
                }

                addLog('===== å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼ =====', 'success');

            } catch (error) {
                addLog(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                console.error(error);
            } finally {
                createBtn.disabled = false;
            }
        }

        createBtn.addEventListener('click', createPermanentRooms);

        addLog('æº–å‚™å®Œäº†ã€‚ã€Œå›ºå®šãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'info');
    </script>
</body>
</html>
